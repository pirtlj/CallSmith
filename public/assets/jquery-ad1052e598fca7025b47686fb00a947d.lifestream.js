/*!
 * jQuery Lifestream Plug-in
 * @version 0.1.2
 * Show a stream of your online activity
 *
 * Copyright 2011, Christian Vuerings - http://denbuzze.com
 */
/*globals jQuery, $ */
(function(a){var b=function(a){return"http://query.yahooapis.com/v1/public/yql?q=__QUERY__&env=store://datatables.org/alltableswithkeys&format=json".replace("__QUERY__",encodeURIComponent(a))};a.fn.lifestream=function(b){return this.each(function(){var c=a(this),d=jQuery.extend({classname:"lifestream",feedloaded:null,limit:10,list:[]},b),e={count:d.list.length,items:[]},f=jQuery.extend(!0,{},d),g=function(b){a.merge(e.items,b),e.items.sort(function(a,b){return b.date-a.date});var f=e.items,g=f.length<d.limit?f.length:d.limit,h=0,i,j=a('<ul class="'+d.classname+'"/>');for(;h<g;h++)i=f[h],i.html&&a('<li class="'+d.classname+"-"+i.config.service+'">').append(i.html).appendTo(j);c.html(j),a.isFunction(d.feedloaded)&&d.feedloaded()},h=function(){var b=0,c=d.list.length;delete f.list;for(;b<c;b++){var e=d.list[b];a.fn.lifestream.feeds[e.service]&&a.isFunction(a.fn.lifestream.feeds[e.service])&&e.user&&(e._settings=f,a.fn.lifestream.feeds[e.service](e,g))}};jQuery.tmpl?h():jQuery.getScript("https://raw.github.com/jquery/jquery-tmpl/master/jquery.tmpl.min.js",h)})},a.fn.lifestream.feeds=a.fn.lifestream.feeds||{},a.fn.lifestream.feeds.blogger=function(c,d){var e=a.extend({},{posted:'posted <a href="${origLink}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.feed.entry){f=b.query.results.feed.entry,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.published),config:c,html:a.tmpl(e.posted,i)})}return d};return a.ajax({url:b('select * from xml where url="http://'+c.user+'.blogspot.com/feeds/posts/default"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.dailymotion=function(c,d){var e=a.extend({},{uploaded:'uploaded a video <a href="${link}">${title[0]}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.rss.channel.item){f=b.query.results.rss.channel.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.pubDate),config:c,html:a.tmpl(e.uploaded,i)})}return d};return a.ajax({url:b('select * from xml where url="http://www.dailymotion.com/rss/user/'+c.user+'"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.delicious=function(b,c){var d=a.extend({},{bookmarked:'bookmarked <a href="${u}">${d}</a>'},b.template);return a.ajax({url:"http://feeds.delicious.com/v2/json/"+b.user,dataType:"jsonp",success:function(e){var f=[],g=0,h;if(e&&e.length&&e.length>0){h=e.length;for(;g<h;g++){var i=e[g];f.push({date:new Date(i.dt),config:b,html:a.tmpl(d.bookmarked,i)})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.deviantart=function(c,d){var e=a.extend({},{posted:'posted <a href="${link}">${title}</a>'},c.template);return a.ajax({url:b('select title,link,pubDate from rss where url="http://backend.deviantart.com/rss.xml?q=gallery%3A'+encodeURIComponent(c.user)+"&type=deviation"+'" | unique(field="title")'),dataType:"jsonp",success:function(b){var f=[],g,h,i=0,j;if(b.query&&b.query.count>0){g=b.query.results.item,j=g.length;for(;i<j;i++)h=g[i],f.push({date:new Date(h.pubDate),config:c,html:a.tmpl(e.posted,h)})}d(f)}}),{template:e}},a.fn.lifestream.feeds.dribbble=function(b,c){var d=a.extend({},{posted:'posted a shot <a href="${url}">${title}</a>'},b.template);return a.ajax({url:"http://api.dribbble.com/players/"+b.user+"/shots",dataType:"jsonp",success:function(e){var f=[],g=0,h;if(e&&e.total){h=e.shots.length;for(;g<h;g++){var i=e.shots[g];f.push({date:new Date(i.created_at),config:b,html:a.tmpl(d.posted,i)})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.flickr=function(b,c){var d=a.extend({},{posted:'posted a photo <a href="${link}">${title}</a>'},b.template);return a.ajax({url:"http://api.flickr.com/services/feeds/photos_public.gne?id="+b.user+"&lang=en-us&format=json",dataType:"jsonp",jsonp:"jsoncallback",success:function(e){var f=[],g=0,h;if(e&&e.items&&e.items.length>0){h=e.items.length;for(;g<h;g++){var i=e.items[g];f.push({date:new Date(i.published),config:b,html:a.tmpl(d.posted,i)})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.foomark=function(b,c){var d=a.extend({},{bookmarked:'bookmarked <a href="${url}">${url}</a>'},b.template);return a.ajax({url:"http://api.foomark.com/urls/list/",data:{format:"jsonp",username:b.user},dataType:"jsonp",success:function(e){var f=[],g=0,h;if(e&&e.length&&e.length>0){h=e.length;for(;g<h;g++){var i=e[g];f.push({date:new Date(i.created_at.replace(" ","T")),config:b,html:a.tmpl(d.bookmarked,i)})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.formspring=function(c,d){var e=a.extend({},{answered:'answered a question <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.rss.channel.item){f=b.query.results.rss.channel.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.pubDate),config:c,html:a.tmpl(e.answered,i)})}return d};return a.ajax({url:b('select * from xml where url="http://www.formspring.me/profile/'+c.user+'.rss"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.forrst=function(b,c){var d=a.extend({},{posted:'posted a ${post_type} <a href="${post_url}">${title}</a>'},b.template);return a.ajax({url:"http://forrst.com/api/v2/users/posts?username="+b.user,dataType:"jsonp",success:function(e){var f=[],g=0,h;if(e&&e.resp.length&&e.resp.length>0){h=e.resp.length;for(;g<h;g++){var i=e.resp[g];f.push({date:new Date(i.created_at.replace(" ","T")),config:b,html:a.tmpl(d.posted,i)})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.foursquare=function(c,d){var e=a.extend({},{checkedin:'checked in @ <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f=0,g;if(b.query&&b.query.count&&b.query.count>0){g=b.query.count;for(;f<g;f++){var h=b.query.results.item[f];d.push({date:new Date(h.pubDate),config:c,html:a.tmpl(e.checkedin,h)})}}return d};return a.ajax({url:b('select * from rss where url="https://feeds.foursquare.com/history/'+c.user+'.rss"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.github=function(c,d){var e=a.extend({},{pushed:'<a href="${status.url}" title="{{if title}}${title} by ${author} {{/if}}">pushed</a> to <a href="http://github.com/${repo}">${repo}</a>',gist:'<a href="${status.payload.url}" title="${status.payload.desc || ""}">${status.payload.name}</a>',commented:'<a href="${status.url}">commented</a> on <a href="http://github.com/${repo}">${repo}</a>',pullrequest:'<a href="${status.url}">${status.payload.action}</a> pull request on <a href="http://github.com/${repo}">${repo}</a>',created:'created ${status.payload.ref_type || status.payload.object} <a href="${status.url}">${status.payload.ref || status.payload.object_name}</a> for <a href="http://github.com/${repo}">${repo}</a>',createdglobal:'created ${status.payload.object} <a href="${status.url}">${title}</a>',deleted:'deleted ${status.payload.ref_type} <a href="http://github.com/${status.repository.owner}/${status.repository.name}">status.payload.ref</a>'},c.template),f=function(a){return a.payload.repo||(a.repository?a.repository.owner+"/"+a.repository.name:null)||a.url.split("/")[3]+"/"+a.url.split("/")[4]},g=function(b){var c,d;if(b.type==="PushEvent")return d=b.payload&&b.payload.shas&&b.payload.shas.json&&b.payload.shas.json[2],c=f(b),a.tmpl(e.pushed,{status:b,title:d,author:d?b.payload.shas.json[3]:"",repo:f(b)});if(b.type==="GistEvent")return a.tmpl(e.gist,b);if(b.type==="CommitCommentEvent"||b.type==="IssueCommentEvent")return c=f(b),a.tmpl(e.commented,{repo:c,status:b});if(b.type==="PullRequestEvent")return c=f(b),a.tmpl(e.pullrequest,{repo:c,status:b});if(b.type==="CreateEvent"&&(b.payload.ref_type==="tag"||b.payload.ref_type==="branch"||b.payload.object==="tag"))return c=f(b),a.tmpl(e.created,{repo:c,status:b});if(b.type==="CreateEvent")return d=b.payload.object_name==="null"?b.payload.name:b.payload.object_name,a.tmpl(e.createdglobal,{title:d,status:b});if(b.type==="DeleteEvent")return a.tmpl(e.deleted,b)},h=function(a){var b=[],d=0,e;if(a.query&&a.query.count&&a.query.count>0){e=a.query.count;for(;d<e;d++){var f=a.query.results.json[d].json;b.push({date:new Date(f.created_at),config:c,html:g(f)})}}return b};return a.ajax({url:b('select json.repository.owner,json.repository.name,json.payload,json.type,json.url, json.created_at from json where url="http://github.com/'+c.user+'.json"'),dataType:"jsonp",success:function(a){d(h(a))}}),{template:e}},a.fn.lifestream.feeds.googlereader=function(c,d){var e=a.extend({},{starred:'starred post <a href="${link.href}">${title.content}</a>'},c.template),f=function(b){var d=[],f,g=0,h;if(b.query&&b.query.count&&b.query.count>0){f=b.query.results.feed.entry,h=f.length;for(;g<h;g++){var i=f[g];d.push({date:new Date(parseInt(i["crawl-timestamp-msec"],10)),config:c,html:a.tmpl(e.starred,i)})}}return d};return a.ajax({url:b('select * from xml where url="www.google.com/reader/public/atom/user%2F'+c.user+'%2Fstate%2Fcom.google%2Fstarred"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.iusethis=function(c,d){var e=a.extend({},{global:'${action} <a href="${link}">${what}</a> on (${os})'},c.template),f=function(b){var d=[],f,g,h,i,j,k=0,l,m,n,o,p,q,r,s=["iPhone","OS X","Windows"];if(b.query&&b.query.count&&b.query.count>0&&b.query.results.rss){l=b.query.results.rss.length,o=["started using","stopped using","stopped loving","Downloaded","commented on","updated entry for","started loving","registered"],j=o.length;for(;k<l;k++){r=s[k],f=b.query.results.rss[k].channel.item,g=0,h=f.length;for(;g<h;g++){m=f[g],n=m.title.replace(c.user+" ",""),i=0;for(;i<j;i++)if(n.indexOf(o[i])>-1){p=o[i];break}q=n.split(p),d.push({date:new Date(m.pubDate),config:c,html:a.tmpl(e.global,{action:p.toLowerCase(),link:m.link,what:q[1],os:r})})}}}return d};return a.ajax({url:b('select * from xml where url="http://iphone.iusethis.com/user/feed.rss/'+c.user+'" or '+'url="http://osx.iusethis.com/user/feed.rss/'+c.user+'" or '+'url="http://win.iusethis.com/user/feed.rss/'+c.user+'"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.lastfm=function(c,d){var e=a.extend({},{loved:'loved <a href="${url}">${name}</a> by <a href="${artist.url}">${artist.name}</a>'},c.template),f=function(b){var d=[],f,g=0,h;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.lovedtracks&&b.query.results.lovedtracks.track){f=b.query.results.lovedtracks.track,h=f.length;for(;g<h;g++){var i=f[g];d.push({date:new Date(parseInt(i.date.uts*1e3,10)),config:c,html:a.tmpl(e.loved,i)})}}return d};return a.ajax({url:b('select * from xml where url="http://ws.audioscrobbler.com/2.0/user/'+c.user+'/lovedtracks.xml"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.picplz=function(b,c){var d=a.extend({},{uploaded:'uploaded <a href="${url}">${title}</a>'},b.template);return a.ajax({url:"http://picplz.com/api/v2/user.json?username="+b.user+"&include_pics=1",dataType:"jsonp",success:function(e){var f=[],g=0,h,i;i=e.value.users[0].pics;if(i&&i.length&&i.length>0){h=i.length;for(;g<h;g++){var j=i[g];f.push({date:new Date(j.date*1e3),config:b,html:a.tmpl(d.uploaded,{url:j.pic_files["640r"].img_url,title:j.caption||j.id})})}}c(f)}}),{template:d}},a.fn.lifestream.feeds.pinboard=function(c,d){var e=a.extend({},{bookmarked:'bookmarked <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0){f=b.query.results.RDF.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.date),config:c,html:a.tmpl(e.bookmarked,i)})}return d};return a.ajax({url:b('select * from xml where url="http://feeds.pinboard.in/rss/u:'+c.user+'"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.posterous=function(c,d){var e=a.extend({},{posted:'posted <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.rss.channel.item){f=b.query.results.rss.channel.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.pubDate),config:c,html:a.tmpl(e.posted,i)})}return d};return a.ajax({url:b('select * from xml where url="http://'+c.user+'.posterous.com/rss.xml"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.reddit=function(b,c){var d=a.extend({},{commented:'<a href="http://www.reddit.com/r/${item.data.subreddit}/comments/${item.data.link_id.substring(3)}/u/${item.data.name.substring(3)}?context=3">commented (${score})</a> in <a href="http://www.reddit.com/r/${item.data.subreddit}">${item.data.subreddit}</a>',created:'<a href="http://www.reddit.com${item.data.permalink}">created new thread (${score})</a> in <a href="http://www.reddit.com/r/${item.data.subreddit}">${item.data.subreddit}</a>'},b.template),e=function(b){var c=b.data.ups-b.data.downs,e={item:b,score:c>0?"+"+c:c};if(b.kind==="t1")return a.tmpl(d.commented,e);if(b.kind==="t3")return a.tmpl(d.created,e)},f=function(a){return new Date(a*1e3)};return a.ajax({url:"http://www.reddit.com/user/"+b.user+".json",dataType:"jsonp",jsonp:"jsonp",success:function(a){var d=[],g=0,h;if(a&&a.data&&a.data.children&&a.data.children.length>0){h=a.data.children.length;for(;g<h;g++){var i=a.data.children[g];d.push({date:f(i.data.created),config:b,html:e(i)})}}c(d)}}),{template:d}},a.fn.lifestream.feeds.slideshare=function(c,d){var e=a.extend({},{uploaded:'uploaded a presentation <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0){f=b.query.results.rss.channel.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.pubDate),config:c,html:a.tmpl(e.uploaded,i)})}return d};return a.ajax({url:b('select * from xml where url="http://www.slideshare.net/rss/user/'+c.user+'"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.stackoverflow=function(b,c){var d=a.extend({},{global:'<a href="${link}">${text}</a> - ${title}'},b.template),e=function(a){var c="",d="",e="",f="http://stackoverflow.com/users/"+b.user,g="http://stackoverflow.com/questions/";if(a.timeline_type==="badge")c=a.timeline_type+" "+a.action+": "+a.description,d=a.detail,e=f+"?tab=reputation";else if(a.timeline_type==="revision"||a.timeline_type==="comment"||a.timeline_type==="accepted"||a.timeline_type==="askoranswered")c=a.post_type+" "+a.action,d=a.detail||a.description||"",e=g+a.post_id;return{link:e,title:d,text:c}},f=function(a){return new Date(a*1e3)};return a.ajax({url:"http://api.stackoverflow.com/1.1/users/"+b.user+"/timeline?"+"jsonp",dataType:"jsonp",jsonp:"jsonp",success:function(g){var h=[],i=0,j;if(g&&g.total&&g.total>0&&g.user_timelines){j=g.user_timelines.length;for(;i<j;i++){var k=g.user_timelines[i];h.push({date:f(k.creation_date),config:b,html:a.tmpl(d.global,e(k))})}}c(h)}}),{template:d}},a.fn.lifestream.feeds.tumblr=function(c,d){var e=a.extend({},{posted:'posted a ${type} <a href="${url}">${title}</a>'},c.template),f=function(a){var b=a["regular-title"]||a["quote-text"]||a["conversation-title"]||a["photo-caption"]||a["video-caption"]||a["audio-caption"]||a["regular-body"]||a["link-text"]||a.type||"";return b.replace(/<.+?>/gi," ")},g=function(b,c){return{date:new Date(c.date),config:b,html:a.tmpl(e.posted,{type:c.type,url:c.url,title:f(c)})}},h=function(b){var d=[],e=0,f,h;if(b.query&&b.query.count&&b.query.count>0)if(a.isArray(b.query.results.posts.post)){f=b.query.results.posts.post.length;for(;e<f;e++)h=b.query.results.posts.post[e],d.push(g(c,h))}else a.isPlainObject(b.query.results.posts.post)&&d.push(g(c,b.query.results.posts.post));return d};return a.ajax({url:b('select * from tumblr.posts where username="'+c.user+'"'),dataType:"jsonp",success:function(a){d(h(a))}}),{template:e}},a.fn.lifestream.feeds.twitter=function(c,d){var e=a.extend({},{posted:"{{html tweet}}"},c.template),f=function(a){var b=function(a){return a.replace(/[a-z]+:\/\/[a-z0-9-_]+\.[a-z0-9-_:~%&\?\/.=]+[^:\.,\)\s*$]/ig,function(a){return'<a href="'+a+'">'+(a.length>25?a.substr(0,24)+"...":a)+"</a>"})},c=function(a){return a.replace(/(^|[^\w]+)\@([a-zA-Z0-9_]{1,15})/g,function(a,b,c){return b+'<a href="http://twitter.com/'+c+'">@'+c+"</a>"})},d=function(a){return a.replace(/(^|[^\w'"]+)\#([a-zA-Z0-9_]+)/g,function(a,b,c){return b+'<a href="http://search.twitter.com/search?q=%23'+c+'">#'+c+"</a>"})};return d(c(b(a)))},g=function(b){var d=[],g=0,h;if(b.query&&b.query.count&&b.query.count>0){h=b.query.count;for(;g<h;g++){var i=b.query.results.statuses[g].status;d.push({date:new Date(i.created_at),config:c,html:a.tmpl(e.posted,{tweet:f(i.text)})})}}return d};return a.ajax({url:b('select status.id, status.created_at, status.text from twitter.user.timeline where screen_name="'+c.user+'"'),dataType:"jsonp",success:function(a){d(g(a))}}),{template:e}},a.fn.lifestream.feeds.vimeo=function(b,c){var d=a.extend({},{posted:'posted <a href="${url}" title="${description}">${title}</a>'},b.template),e=function(c){var e=[],f=0,g,h;if(c){g=c.length;for(;f<g;f++)h=c[f],e.push({date:new Date(h.upload_date.replace(" ","T")),config:b,html:a.tmpl(d.posted,{url:h.url,description:h.description.replace(/"/g,"'").replace(/<.+?>/gi,""),title:h.title})})}return e};return a.ajax({url:"http://vimeo.com/api/v2/"+b.user+"/videos.json",dataType:"jsonp",crossDomain:!0,success:function(a){c(e(a))}}),{template:d}},a.fn.lifestream.feeds.wordpress=function(c,d){var e=a.extend({},{posted:'posted <a href="${link}">${title}</a>'},c.template),f=function(b){var d=[],f,g=0,h,i;if(b.query&&b.query.count&&b.query.count>0&&b.query.results.rss.channel.item){f=b.query.results.rss.channel.item,h=f.length;for(;g<h;g++)i=f[g],d.push({date:new Date(i.pubDate),config:c,html:a.tmpl(e.posted,i)})}return d};return a.ajax({url:b('select * from xml where url="http://'+c.user+'.wordpress.com/feed"'),dataType:"jsonp",success:function(a){d(f(a))}}),{template:e}},a.fn.lifestream.feeds.youtube=function(b,c){var d=a.extend({},{favorited:'favorited <a href="${video.player.default}" title="${video.description}">${video.title}</a>'},b.template),e=function(c){var e=[],f=0,g,h;if(c.data&&c.data.items){g=c.data.items.length;for(;f<g;f++)h=c.data.items[f],e.push({date:new Date(h.created),config:b,html:a.tmpl(d.favorited,h)})}return e};return a.ajax({url:"http://gdata.youtube.com/feeds/api/users/"+b.user+"/favorites?v=2&alt=jsonc",dataType:"jsonp",success:function(a){c(e(a))}}),{template:d}}})(jQuery)